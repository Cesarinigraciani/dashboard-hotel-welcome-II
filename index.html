<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard PCI ‚Äì Inicio</title>
  <link rel="stylesheet" href="styles/style-v2.css" />
</head>

<body>

<!-- üè¢ Cabecera principal -->
<header class="header-principal">
  <img src="assets/img/logo-empresa.png" alt="Logo Aguero Instalaciones">

  <div class="titulo-principal">
    <h1>AVANCES PROYECTOS PCI</h1>
    <h2>Aguero Instalaciones</h2>
    <h3 class="subfirma">v3.0.0 ‚Äî By: C√©sar Augusto</h3>
  </div>
</header>

<!-- üîò Botones principales -->
<div class="container">
  <button onclick="mostrarFormulario()" class="boton-seccion">Generar Proyecto Nuevo</button>
  <button onclick="mostrarLista()" class="boton-seccion">Abrir Proyecto Existente</button>
  <button onclick="modificarProyecto()" class="boton-seccion">Modificar Proyecto</button>
  <button id="btn-instalar" class="boton-seccion" title="Instalar Dashboard Aguero-PCI">Instalar App</button>
  <button onclick="borrarProyecto()" class="boton-seccion">Borrar Proyecto</button>
  <button onclick="modificarPlantas()" class="boton-seccion">Modificar Plantas</button>
</div>

<!-- üìù Formulario nuevo proyecto -->
<form id="formProyecto" class="form-proyecto" style="display: none;">
  <h3>Crear Nuevo Proyecto</h3>

  <div class="form-group">
    <label>Nombre del Proyecto</label>
    <input type="text" name="nombre" placeholder="Ej. Residencias Misterios">
  </div>

  <div class="form-group">
    <label>Direcci√≥n</label>
    <input type="text" name="direccion" placeholder="Ej. Calle Fuego 123">
  </div>

  <div class="form-row">
    <div class="form-group">
      <label>C√≥digo Postal</label>
      <input type="text" name="cp" placeholder="28053">
    </div>

    <div class="form-group">
      <label>Ciudad</label>
      <input type="text" name="ciudad" placeholder="Madrid">
    </div>
  </div>

  <div class="form-group">
    <label>Ingeniero T√©cnico Encargado</label>
    <input type="text" name="ingeniero" placeholder="Ej. Juan P√©rez">
  </div>

  <div class="form-row">
    <div class="form-group">
      <label>Fecha Inicio de Obra</label>
      <input type="date" name="fecha">
    </div>

    <div class="form-group">
      <label>Tiempo estimado (horas)</label>
      <input type="number" name="tiempo" placeholder="120">
    </div>
  </div>

  <div class="form-group">
    <label>T√©cnico Encargado PCI</label>
    <input type="text" name="tecnico" placeholder="Ej. C√©sar Augusto">
  </div>

  <button type="button" class="btn-secundario" onclick="generarPlantas()"> Configurar Plantas</button>

  <div id="panelPlantas" style="display:none; margin-top:20px;">
    <label>N√∫mero de plantas:</label>
    <input type="number" id="numPlantas" min="1" max="20" value="1">

    <button type="button" class="btn-secundario" onclick="crearTarjetasPlantas()">Generar</button>

    <div id="contenedorPlantas" style="margin-top:20px;"></div>
  </div>

  <button type="button" class="btn-primario" onclick="guardarProyecto()">üíæ Guardar Proyecto</button>
</form>

<!-- üìÇ Lista de proyectos existentes -->
<div id="listaProyectos" style="display: none;">
  <h3>Proyectos Existentes</h3>

  <select id="proyectosSelect" style="display: block; margin-bottom: 15px;">
    <option value="">Seleccione un proyecto...</option>
  </select>

  <div class="acciones-proyecto">
    <button onclick="modificarProyecto()"> Modificar Proyecto</button>
    <button onclick="borrarProyecto()"> Borrar Proyecto</button>
    <button onclick="modificarPlantas()"> Modificar Plantas</button>
    <button onclick="abrirProyectoSeleccionado()"> Abrir Proyecto</button>
  </div>
</div>

<script>
/* ‚úÖ Detectar si venimos a editar un proyecto */
window.addEventListener("load", () => {
  const modoEdicion = localStorage.getItem("modoEdicion");
  const proyecto = JSON.parse(localStorage.getItem("proyectoSeleccionado"));

  if (modoEdicion === "true" && proyecto && proyecto.id) {
    mostrarFormulario();
    cargarProyectoEnFormulario(proyecto);
    localStorage.removeItem("modoEdicion");
  }
});

/* ‚úÖ Mostrar formulario */
function mostrarFormulario() {
  document.getElementById('formProyecto').style.display = 'block';
  document.getElementById('listaProyectos').style.display = 'none';
  document.getElementById('proyectosSelect').style.display = 'none';
}

/* ‚úÖ Mostrar lista de proyectos */
function mostrarLista() {
  document.getElementById('formProyecto').style.display = 'none';
  document.getElementById('listaProyectos').style.display = 'block';

  const select = document.getElementById('proyectosSelect');
  select.style.display = "block";
  select.innerHTML = `<option value="">Seleccione un proyecto...</option>`;

  const lista = JSON.parse(localStorage.getItem("proyectosPCI")) || [];

  lista.forEach(p => {
    const opt = document.createElement("option");
    opt.value = p.id;
    opt.textContent = p.nombre;
    select.appendChild(opt);
  });

  select.appendChild(new Option("Hotel Welcome II", "welcomeII"));
  select.appendChild(new Option("Residencias Misterios", "misterios"));
}

/* ‚úÖ Abrir proyecto */
function abrirProyecto(id) {
  if (!id) return;

  if (id === "welcomeII") {
    window.location.href = "dashboard_welcome.html";
    return;
  }

  if (id === "misterios") {
    window.location.href = "dashboard_misterios.html";
    return;
  }

  const lista = JSON.parse(localStorage.getItem("proyectosPCI")) || [];
  const proyecto = lista.find(p => p.id == id);

  if (!proyecto) {
    alert("Proyecto no encontrado");
    return;
  }

  localStorage.setItem("proyectoSeleccionado", JSON.stringify(proyecto));
  window.location.href = "dashboard_dinamico.html";
}

/* ‚úÖ Bot√≥n: Abrir proyecto seleccionado */
function abrirProyectoSeleccionado() {
  const id = document.getElementById("proyectosSelect").value;

  if (!id) {
    alert("Seleccione un proyecto primero");
    return;
  }

  abrirProyecto(id);
}

/* ‚úÖ Mostrar panel de plantas */
function generarPlantas() {
  document.getElementById("panelPlantas").style.display = "block";
}

/* ‚úÖ Modificar proyecto */
function modificarProyecto() {
  const id = document.getElementById("proyectosSelect").value;

  if (!id) {
    alert("Seleccione un proyecto primero");
    return;
  }

  if (id === "welcomeII" || id === "misterios") {
    alert("Este proyecto no permite modificaci√≥n de datos");
    return;
  }

  const lista = JSON.parse(localStorage.getItem("proyectosPCI")) || [];
  const proyecto = lista.find(p => p.id == id);

  if (!proyecto) {
    alert("Proyecto no encontrado");
    return;
  }

  localStorage.setItem("proyectoSeleccionado", JSON.stringify(proyecto));
  localStorage.setItem("modoEdicion", "true");

  mostrarFormulario();
  cargarProyectoEnFormulario(proyecto);
}

/* ‚úÖ Borrar proyecto */
function borrarProyecto() {
  const id = document.getElementById("proyectosSelect").value;

  if (!id) {
    alert("Seleccione un proyecto primero");
    return;
  }

  if (id === "welcomeII" || id === "misterios") {
    alert("Este proyecto no se puede borrar");
    return;
  }

  let lista = JSON.parse(localStorage.getItem("proyectosPCI")) || [];
  lista = lista.filter(p => p.id != id);

  localStorage.setItem("proyectosPCI", JSON.stringify(lista));

  alert("‚úÖ Proyecto borrado correctamente");
  window.location.reload();
}

/* ‚úÖ Crear tarjetas de plantas */
function crearTarjetasPlantas() {
  const num = parseInt(document.getElementById("numPlantas").value);
  const contenedor = document.getElementById("contenedorPlantas");
  contenedor.innerHTML = "";

  for (let i = 1; i <= num; i++) {
    const tarjeta = document.createElement("div");
    tarjeta.className = "tarjeta-planta";
    tarjeta.innerHTML = `
      <h4>Planta ${i}</h4>

      <label>Nombre personalizado:
        <input type="text" class="nombre-planta" placeholder="Ej: Planta ${i}">
      </label>

      <label>Equipos a instalar:</label>
      <select class="select-equipos">
        <option value="Detectores">Detectores</option>
        <option value="Siray+Bscl">Siray+Bscl</option>
        <option value="Zocalos">Z√≥calos</option>
        <option value="Central">Central Cofem</option>
        <option value="Baterias">Bater√≠as</option>
        <option value="Pukay">Pukay</option>
        <option value="Mstay 8">Mstay 8</option>
        <option value="Mda2 Ylt">Mdy2 Ylt</option>
        <option value="Kamay">Kamay</option>
        <option value="Kit-Pmr">Kit-Pmr</option>
        <option value="Mda1y">Mda1y</option>
        <option value="Fuente Auxiliar">Fuente Auxiliar</option>
        <option value="Extintores">Extintores</option>
        <option value="Soportes">Soportes</option>
      </select>

      <button type="button" onclick="agregarEquipo(this)">A√±adir equipo</button>

      <ul class="lista-equipos"></ul>

      <button type="button" class="btn-eliminar-planta" style="
        margin-top:10px;
        background:#c0392b;
        color:white;
        border:none;
        padding:6px 10px;
        border-radius:4px;
      ">Eliminar planta</button>
    `;

    contenedor.appendChild(tarjeta);

    const inputNombre = tarjeta.querySelector(".nombre-planta");
    const titulo = tarjeta.querySelector("h4");

    inputNombre.addEventListener("input", () => {
      const nuevoNombre = inputNombre.value.trim();
      titulo.textContent = nuevoNombre || `Planta ${i}`;
    });
  }
}

/* ‚úÖ A√±adir equipo editable */
function agregarEquipo(btn) {
  const tarjeta = btn.closest(".tarjeta-planta");
  const select = tarjeta.querySelector(".select-equipos");
  const lista = tarjeta.querySelector(".lista-equipos");

  const equipoSeleccionado = select.value;

  const nuevoItem = document.createElement("li");

  const input = document.createElement("input");
  input.type = "text";
  input.className = "equipo-editable";
  input.value = equipoSeleccionado;
  input.style.marginRight = "10px";

  const botonEliminar = document.createElement("button");
  botonEliminar.type = "button";
  botonEliminar.className = "btn-eliminar-equipo";
  botonEliminar.textContent = "üóëÔ∏è";

  botonEliminar.addEventListener("click", () => {
    nuevoItem.remove();
  });

  nuevoItem.appendChild(input);
  nuevoItem.appendChild(botonEliminar);
  lista.appendChild(nuevoItem);
}

/* ‚úÖ Guardar proyecto nuevo */
function guardarProyecto() {
  const plantas = [];

  document.querySelectorAll(".tarjeta-planta").forEach(t => {
    const nombre = t.querySelector(".nombre-planta").value || "Sin nombre";

    const equipos = [];
    t.querySelectorAll(".lista-equipos li").forEach(li => {
      const input = li.querySelector(".equipo-editable");
      if (input && input.value.trim() !== "") {
        equipos.push(input.value.trim());
      }
    });

    plantas.push({ nombre, equipos });
  });

  const proyecto = {
    id: Date.now(),
    nombre: document.querySelector("input[name='nombre']").value,
    direccion: document.querySelector("input[name='direccion']").value,
    cp: document.querySelector("input[name='cp']").value,
    ciudad: document.querySelector("input[name='ciudad']").value,
    ingeniero: document.querySelector("input[name='ingeniero']").value,
    fecha: document.querySelector("input[name='fecha']").value,
    tiempo: document.querySelector("input[name='tiempo']").value,
    tecnico: document.querySelector("input[name='tecnico']").value,
    plantas
  };

  let lista = JSON.parse(localStorage.getItem("proyectosPCI")) || [];
  lista.push(proyecto);
  localStorage.setItem("proyectosPCI", JSON.stringify(lista));

  alert("‚úÖ Proyecto guardado correctamente");
  window.location.reload();
}

/* ‚úÖ Guardar cambios */
function guardarCambios() {
  const proyecto = JSON.parse(localStorage.getItem("proyectoSeleccionado"));
  if (!proyecto) {
    alert("Error: no hay proyecto cargado");
    return;
  }

  proyecto.nombre = document.querySelector("input[name='nombre']").value;
  proyecto.direccion = document.querySelector("input[name='direccion']").value;
  proyecto.cp = document.querySelector("input[name='cp']").value;
  proyecto.ciudad = document.querySelector("input[name='ciudad']").value;
  proyecto.ingeniero = document.querySelector("input[name='ingeniero']").value;
  proyecto.fecha = document.querySelector("input[name='fecha']").value;
  proyecto.tiempo = document.querySelector("input[name='tiempo']").value;
  proyecto.tecnico = document.querySelector("input[name='tecnico']").value;

  proyecto.plantas = [];
  document.querySelectorAll(".tarjeta-planta").forEach(t => {
    const nombre = t.querySelector(".nombre-planta").value || "Sin nombre";

    const equipos = [];
    t.querySelectorAll(".lista-equipos li").forEach(li => {
      const input = li.querySelector(".equipo-editable");
      if (input && input.value.trim() !== "") {
        equipos.push(input.value.trim());
      }
    });

    proyecto.plantas.push({ nombre, equipos });
  });

  let lista = JSON.parse(localStorage.getItem("proyectosPCI")) || [];
  const index = lista.findIndex(p => p.id === proyecto.id);
  if (index !== -1) {
    lista[index] = proyecto;
  }

  localStorage.setItem("proyectosPCI", JSON.stringify(lista));

  alert("‚úÖ Cambios guardados correctamente");
  window.location.reload();

  localStorage.removeItem("modoEdicion");
  localStorage.removeItem("proyectoSeleccionado");
  window.location.href = "index.html";
}

/* ‚úÖ Cargar proyecto en modo edici√≥n */
function cargarProyectoEnFormulario(proyecto) {
  document.querySelector("input[name='nombre']").value = proyecto.nombre || "";
  document.querySelector("input[name='direccion']").value = proyecto.direccion || "";
  document.querySelector("input[name='cp']").value = proyecto.cp || "";
  document.querySelector("input[name='ciudad']").value = proyecto.ciudad || "";
  document.querySelector("input[name='ingeniero']").value = proyecto.ingeniero || "";
  document.querySelector("input[name='fecha']").value = proyecto.fecha || "";
  document.querySelector("input[name='tiempo']").value = proyecto.tiempo || "";
  document.querySelector("input[name='tecnico']").value = proyecto.tecnico || "";

  const contenedor = document.getElementById("contenedorPlantas");
  contenedor.innerHTML = "";
  document.getElementById("panelPlantas").style.display = "block";

  proyecto.plantas.forEach((planta, index) => {
    const tarjeta = document.createElement("div");
    tarjeta.className = "tarjeta-planta";

    tarjeta.innerHTML = `
      <h4>Planta ${index + 1}</h4>

      <label>Nombre personalizado:
        <input type="text" class="nombre-planta" value="${planta.nombre}">
      </label>

      <label>Equipos a instalar:</label>
      <select class="select-equipos">
        <option value="Detectores">Detectores</option>
        <option value="Siray+Bscl">Siray+Bscl</option>
        <option value="Zocalos">Z√≥calos</option>
        <option value="Central">Central Cofem</option>
        <option value="Baterias">Bater√≠as</option>
        <option value="Pukay">Pukay</option>
        <option value="Mstay 8">Mstay 8</option>
        <option value="Mda2 Ylt">Mdy2 Ylt</option>
        <option value="Kamay">Kamay</option>
        <option value="Kit-Pmr">Kit-Pmr</option>
        <option value="Mda1y">Mda1y</option>
        <option value="Fuente Auxiliar">Fuente Auxiliar</option>
        <option value="Extintores">Extintores</option>
        <option value="Soportes">Soportes</option>
      </select>

      <button type="button" onclick="agregarEquipo(this
 <button type="button" class="btn-eliminar-planta">Eliminar planta</button>

<ul class="lista-equipos"></ul>
`;

    // ‚úÖ Insertar equipos editables con bot√≥n eliminar
    const lista = tarjeta.querySelector(".lista-equipos");

    planta.equipos.forEach(eq => {
      const li = document.createElement("li");

      // Input editable
      const input = document.createElement("input");
      input.type = "text";
      input.className = "equipo-editable";
      input.value = eq;
      input.style.marginRight = "10px";

      // Bot√≥n eliminar
      const btnEliminar = document.createElement("button");
      btnEliminar.type = "button";
      btnEliminar.className = "btn-eliminar-equipo";
      btnEliminar.textContent = "üóëÔ∏è";

      // Evento de borrado
      btnEliminar.addEventListener("click", () => {
        li.remove();
      });

      li.appendChild(input);
      li.appendChild(btnEliminar);
      lista.appendChild(li);
    });

    contenedor.appendChild(tarjeta);
  });
}
</script> <!-- ‚úÖ ESTE CIERRE ES OBLIGATORIO -->

<script>
// ‚úÖ Delegaci√≥n global para eliminar plantas (funciona siempre)
document.addEventListener("click", (e) => {
  if (e.target.classList.contains("btn-eliminar-planta")) {
    const tarjeta = e.target.closest(".tarjeta-planta");
    if (tarjeta) tarjeta.remove();
  }
});

// ‚úÖ Delegaci√≥n para sincronizar nombre con el t√≠tulo
document.addEventListener("input", (e) => {
  if (e.target.classList.contains("nombre-planta")) {
    const tarjeta = e.target.closest(".tarjeta-planta");
    const titulo = tarjeta.querySelector("h4");
    const valor = e.target.value.trim();
    const numero = titulo.textContent.match(/\d+/)?.[0] || "";
    titulo.textContent = valor || `Planta ${numero}`;
  }
});
</script>

<!-- ‚úÖ Solo activar "Guardar Cambios" si estamos en modo edici√≥n -->
<script>
if (localStorage.getItem("modoEdicion") === "true") {
  const btnGuardar = document.querySelector(".btn-primario");
  btnGuardar.textContent = "Guardar Cambios";
  btnGuardar.onclick = guardarCambios;
}
</script>

<!-- üìÅ Librer√≠a jsPDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<!-- üìÑ Script principal -->
<script src="scripts/main-v2.js" defer></script>

<!-- üîß Registro del Service Worker -->
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js')
    .then(reg => console.log('‚úÖ Service Worker registrado:', reg))
    .catch(err => console.error('‚ùå Error al registrar el Service Worker:', err));
}
</script>

</body>
</html>








